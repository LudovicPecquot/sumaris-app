<app-toolbar
  *ngIf="showToolbar"
  [title]="$title | async"
  [color]="toolbarColor"
  [hasValidate]="!loading && (dirty || saving)"
  [hasClose]="!loading && !dirty && !saving"
  (onValidate)="save($event)"
  (onValidateAndClose)="saveAndClose($event)"
  (onClose)="close($event)"
  [defaultBackHref]="defaultBackHref"
  [canGoBack]="true"
>
  <button
    slot="end"
    mat-icon-button
    *ngIf="showOptionsMenu && ((enabled && !isNewData) || debug)"
    [matMenuTriggerFor]="optionsMenu"
    [title]="'COMMON.BTN_OPTIONS' | translate"
  >
    <mat-icon>more_vert</mat-icon>
  </button>
</app-toolbar>

<!-- Type = options menu -->
<mat-menu #optionsMenu="matMenu">
  <!-- report -->
  <button mat-menu-item *ngIf="enableReport" [disabled]="isNewData || disabled" (click)="openReport($event)">
    <mat-icon><ion-icon slot="icon-only" name="bar-chart-outline"></ion-icon></mat-icon>
    <ion-label translate>OBSERVED_LOCATION.EDIT.BTN_REPORT</ion-label>
  </button>

  <button mat-menu-item *ngIf="canCopyLocally" (click)="copyLocally()">
    <mat-icon>file_copy</mat-icon>
    <ion-label translate>COMMON.DEBUG.BTN_COPY_LOCALLY</ion-label>
  </button>

  <mat-divider></mat-divider>

  <!-- delete -->
  <button mat-menu-item [disabled]="isNewData || disabled" (click)="delete($event)">
    <mat-icon>delete</mat-icon>
    <ion-label translate>COMMON.BTN_DELETE</ion-label>
  </button>

  <!-- reset -->
  <button mat-menu-item *ngIf="mobile" [disabled]="!dirty" (click)="cancel($event)">
    <mat-icon>
      <ion-icon slot="start" name="refresh"></ion-icon>
    </mat-icon>
    <ion-label translate>COMMON.BTN_RESET</ion-label>
  </button>
</mat-menu>

<ion-content>
  <mat-tab-group
    #tabGroup
    class="mat-tab-fixed-content"
    [(selectedIndex)]="selectedTabIndex"
    (selectedTabChange)="onTabChange($event)"
    [animationDuration]="mobile ? tabGroupAnimationDuration : '0s'"
    [dynamicHeight]="false"
  >
    <!-- TAB: general -->
    <mat-tab [label]="'OBSERVED_LOCATION.EDIT.TAB_GENERAL' | translateContext : i18nContext.suffix"
          appSubMenuTab [parentPath]="defaultBackHref" [subMenuTitle]="(titleSubject|async|noHtml)||''">
      <ng-template mat-tab-label>
        <mat-icon>information-circle</mat-icon>
        <ion-label translate>OBSERVED_LOCATION.EDIT.TAB_GENERAL</ion-label>
        <ion-icon
          slot="end"
          name="alert-circle"
          color="danger"
          *ngIf="error || (submitted && observedLocationForm.invalid)"
        ></ion-icon>
      </ng-template>

      <div>
        <!-- error -->
        <ion-item
          *ngIf="error || observedLocationForm.error; let errorMsg"
          visible-xs
          visible-sm
          visible-mobile
          lines="none"
        >
          <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
          <ion-label color="danger" class="error" [innerHTML]="errorMsg | translate"></ion-label>
        </ion-item>

        <!-- DEBUG -->
        <app-debug *ngIf="debug" title="Observed location form">
          <ion-grid>
            <ion-row>
              <ion-col>
                editor.ready: {{ readySubject | async }}
                <br />
                editor.loading: {{ loading }}
                <br />
                editor.enabled: {{ enabled }}
                <br />
                editor.data: {{ !!data }}
                <br />
              </ion-col>
              <ion-col>
                form.ready: {{ observedLocationForm.readySubject | async }}
                <br />
                form.loading: {{ observedLocationForm.loading }}
                <br />
                form.enabled: {{ observedLocationForm.enabled }}
                <br />
                form.data: {{ !!observedLocationForm.value }}
                <br />
              </ion-col>
              <ion-col>
                form.startDateTime:
                {{ observedLocationForm.form | formGetValue : 'startDateTime' | dateFormat : { time: true } }}
                <br />
                form.endDateTime:
                {{ observedLocationForm.form | formGetValue : 'endDateTime' | dateFormat : { time: true } }}
                <br />
                form.program: {{ observedLocationForm.form | formGetValue : 'program' | propertyGet : 'label' }}
                <br />
                <br />
                showLandingTab: {{ showLandingTab }}
                <br />
                landingTableType: {{ $landingTableType | async }}
                <br />
              </ion-col>
            </ion-row>
          </ion-grid>
        </app-debug>

        <ion-grid class="ion-no-padding">
          <ion-row class="ion-no-padding">
            <ion-col class="ion-padding">
              <!-- observed location -->
              <app-form-observed-location
                #observedLocationForm
                [programLabel]="programLabel$ | async"
                [showError]="false"
                [showEndDateTime]="false"
                [debug]="debug"
                (onSubmit)="save($event)"
                [timezone]="dbTimeZone"
              ></app-form-observed-location>
            </ion-col>

            <!-- quality data -->
            <ion-col size="12" size-xl="3" class="ion-no-padding">
              <app-entity-metadata [value]="data" [showRecorder]="showRecorder">

                <!-- Compose message -->
                <ion-button recorderSuffix *ngIf="showRecorder && canSendMessage"
                            slot="end" size="small" fill="clear" color="tertiary"
                            class="visible-hover ion-no-margin"
                            [title]="'DATA.BTN_WRITE_TO_RECORDER'|translate"
                            (click)="openComposeMessageModal(data?.recorderPerson)">
                  <ion-icon slot="icon-only" name="mail"></ion-icon>
                </ion-button>

                <!-- quality process -->
                <app-entity-quality-form *ngIf="showQualityForm">
                </app-entity-quality-form>
              </app-entity-metadata>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
    </mat-tab>

    <!-- TAB: Landings -->
    <mat-tab
      #landingsTab
      [label]="'OBSERVED_LOCATION.EDIT.TAB_LANDINGS' | translateContext : i18nContext.suffix"
      [disabled]="!showLandingTab"
      appSubMenuTab
    >
      <ng-template mat-tab-label>
        <mat-icon><ion-icon name="boat"></ion-icon></mat-icon>
        <ng-container *rxIf="$table; let table; suspense: suspense">
          <ion-label
            [matBadge]="table.visibleRowCount"
            [matBadgeHidden]="table.invalid || !table.visibleRowCount"
            matBadgeOverlap="false"
            matBadgeColor="primary"
            matBadgeSize="small"
            matBadgePosition="above after"
          >
            {{ landingsTab.textLabel }}
          </ion-label>
          <ion-icon slot="end" name="alert-circle" color="danger" *ngIf="table.invalid"></ion-icon>
        </ng-container>
        <ng-template #suspense>
          <ion-label><ion-skeleton-text style="min-width: 110px"></ion-skeleton-text></ion-label>
        </ng-template>
      </ng-template>

      <div class="ion-no-padding">
        <!-- error -->
        <ion-item *ngIf="($table | async)?.error" visible-xs visible-sm visible-mobile lines="none">
          <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
          <ion-label color="danger" class="error" [innerHTML]="($table | async)?.error | translate"></ion-label>
        </ion-item>

        <ng-container [ngSwitch]="$landingTableType | async">
          <!-- aggregated landings -->
          <app-aggregated-landings-table
            #aggregatedLandingsTable
            *ngSwitchCase="'aggregated'"
            [debug]="debug"
            [programLabel]="programLabel$ | async"
            (onNewRow)="onNewAggregatedLanding($event)"
            [showToolbar]="!mobile"
            [useSticky]="true"
            (ngInit)="$table.next(aggregatedLandingsTable)"
          ></app-aggregated-landings-table>

          <!-- landings -->
          <app-landings-table
            #landingsTable
            *ngSwitchCase="'legacy'"
            [debug]="debug"
            [programLabel]="programLabel$ | async"
            [showObserversColumn]="false"
            [showDateTimeColumn]="false"
            [showToolbar]="!mobile"
            (onOpenRow)="onOpenLanding($event)"
            (onNewRow)="onNewLanding($event)"
            (openTrip)="onOpenTrip($event)"
            (newTrip)="onNewTrip($event)"
            (ngInit)="$table.next(landingsTable)"
          ></app-landings-table>
        </ng-container>
      </div>
    </mat-tab>
  </mat-tab-group>
</ion-content>

<ion-footer hidden-xs hidden-sm hidden-mobile>
  <app-form-buttons-bar
    (onCancel)="reloadWithConfirmation()"
    [disabledCancel]="!dirty || loading"
    (onSave)="save($event)"
    [disabled]="!dirty || loading"
  >
    <!-- error -->
    <ion-item *ngIf="error" lines="none">
      <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
      <ion-label color="danger" [innerHTML]="error | translate"></ion-label>
    </ion-item>
  </app-form-buttons-bar>
</ion-footer>

<!-- FAB button: add landing -->
<ion-fab
  vertical="bottom"
  horizontal="end"
  slot="fixed"
  *ngIf="selectedTabIndex === 1"
  @fadeInOutAnimation
  visible-xs
  visible-sm
  visible-mobile
>
  <ion-fab-button color="tertiary" (click)="addRow($event)">
    <ion-icon name="add"></ion-icon>
  </ion-fab-button>
</ion-fab>
