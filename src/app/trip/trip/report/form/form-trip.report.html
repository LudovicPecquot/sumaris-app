<ng-container *ngIf="showToolbar">
  <app-toolbar *ngIf="!modal; else modalToolbar" [defaultBackHref]="$defaultBackHref | async" canGoBack="false">
    <ion-title [innerHTML]="$title | async"></ion-title>

    <ion-buttons slot="end">
      <!-- Refresh -->
      <ion-button *ngIf="uuid | isNilOrBlank" (click)="onRefresh.emit()" [title]="'COMMON.BTN_REFRESH' | translate">
        <mat-icon>refresh</mat-icon>
      </ion-button>

      <!-- Help button -->
      <ion-button (click)="reveal.toggleHelp()">
        <mat-icon>help_outline</mat-icon>
      </ion-button>

      <!-- Print -->
      <!-- FIXME enable for mobile, using a Capacitor plugin ? -->
      <ion-button (click)="reveal.print($event)" *ngIf="!mobile">
        <!-- Print button -->
        <ion-icon name="print"></ion-icon>
      </ion-button>

      <!-- share menu -->
      <button mat-icon-button matHeader [title]="'COMMON.SHARE.BTN_SHARE' | translate" [matMenuTriggerFor]="shareMenu">
        <mat-icon>share</mat-icon>
      </button>
    </ion-buttons>
  </app-toolbar>

  <mat-menu #shareMenu="matMenu" xPosition="after">
    <!-- Share popover -->
    <button mat-menu-item (click)="showSharePopover($event)" [disabled]="(loadingSubject | async) || network.offline">
      <ion-label>{{ 'COMMON.SHARE.BTN_SHARE_DOTS' | translate }}</ion-label>
    </button>
  </mat-menu>

  <ng-template #modalToolbar>
    <app-modal-toolbar *ngIf="showToolbar" [modalName]="modalName" [color]="'secondary'" (cancel)="cancel()" [canValidate]="false">
      <ion-title [innerHTML]="$title | async"></ion-title>

      <!-- Print button -->
      <ion-button slot="end" (click)="reveal.print($event)">
        <ion-icon name="print"></ion-icon>
      </ion-button>

      <!-- Close button (on desktop screen) -->
      <ion-button hidden-xs hidden-sm hidden-mobile slot="end" (click)="cancel()" (keyup.enter)="cancel()">
        <ion-label translate>COMMON.BTN_CLOSE</ion-label>
      </ion-button>
    </app-modal-toolbar>
  </ng-template>
</ng-container>

<ion-content>
  <ion-item *ngIf="error && showError" lines="none">
    <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
    <ion-label color="danger" class="error" [innerHTML]="error | translate"></ion-label>
  </ion-item>

  <app-reveal #reveal [options]="revealOptions" *ngIf="loaded; else loadingTemplate">
    <section *sectionDef class="portrait">
      <ion-grid class="report-header ion-no-padding">
        <ion-row class="document-title">
          <ion-col class="logo" size="2">
            @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
              <img [src]="stats.logoHeadLeftUrl" />
            }
          </ion-col>
          <ion-col size="8">
            <h1 class="ion-text-uppercase">{{ 'TRIP.REPORT.FORM.TITLE' | translate }}</h1>
            <h2>
              @if (stats?.subtitle | isNotNilOrBlank) {
                {{ stats.subtitle }}
              }
              <!-- TODO -->
              <!-- else { -->
              <!-- } -->
            </h2>
          </ion-col>
          <ion-col class="logo" size="2">
            @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
              <img [src]="stats.logoHeadRightUrl" />
            }
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid class="report-section">
        <ion-row class="page-title ion-padding">
          <ion-col>
            <h2>{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.TITLE' | translate }}</h2>
          </ion-col>
        </ion-row>
        <ion-row class="section-title">
          <ion-col>
            <h3>{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.SECTION_TITLE.LINK_WITH_THE_SAMPLING_PLAN' | translate }}</h3>
          </ion-col>
        </ion-row>
        <ion-row class="form-field" [style.--form-field-height]="'90px'">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.SAMPLING_STATA_LABEL' | translate }}
          </ion-col>
          <ion-col class="form-value" size="8"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.ATTACHMENT_PROGRAM' | translate }}
          </ion-col>
          <ion-col class="form-value no-border-top" size="8"></ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid class="report-section">
        <ion-row class="section-title">
          <ion-col>
            <h3>{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.SECTION_TITLE.OBSERVERS' | translate }}</h3>
          </ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.OBSERVERS_NAMES' | translate }}
          </ion-col>
          <ion-col class="form-value" size="8"></ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid class="report-section">
        <ion-row class="section-title">
          <ion-col>
            <h3>{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.SECTION_TITLE.TRIP_DEPARTURE' | translate }}</h3>
          </ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.VESSEL_REGISTRATION_CODE' | translate }}
          </ion-col>
          <ion-col class="form-value" size="8"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.VESSEL_NAME' | translate }}
          </ion-col>
          <ion-col class="form-value no-border-top" size="8"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.DEPARTURE_LOCATION' | translate }}
          </ion-col>
          <ion-col class="form-value no-border-top" size="8"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.DEPARTURE_DATE_TIME' | translate }}
          </ion-col>
          <ion-col class="form-value no-border-top" size="3"></ion-col>
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.NB_FISHERMEN' | translate }}
            <br />
            <span class="tips">{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.NB_FISHERMEN_TIPS' | translate }}</span>
          </ion-col>
          <ion-col class="form-value no-border-top" size="1"></ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid class="report-section">
        <ion-row class="section-title">
          <ion-col>
            <h3>{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.SECTION_TITLE.TRIP_RETURN' | translate }}</h3>
          </ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.RETURN_LOCATION' | translate }}
          </ion-col>
          <ion-col class="form-value" size="8"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.RETURN_DATE_TIME' | translate }}
          </ion-col>
          <ion-col class="form-value no-border-top" size="3"></ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid class="report-section">
        <ion-row class="section-title">
          <ion-col>
            <h3>{{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.SECTION_TITLE.SALES' | translate }}</h3>
          </ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.SELL_LOCATION' | translate }}
          </ion-col>
          <ion-col class="form-value" size="8"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="4">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.SELL_DATE' | translate }}
          </ion-col>
          <ion-col class="form-value no-border-top no-border-bottom" size="3"></ion-col>
        </ion-row>
        <ion-row class="form-field">
          <ion-col class="form-label" size="2">
            {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.SELL_TYPE' | translate }}
          </ion-col>
          <ion-col class="form-value" size="10">
            <ion-grid>
              <ion-row>
                @for (type of stats.saleTypes; track $index) {
                  <ion-col class="horiz-checkbox">
                    {{ type }}&nbsp;
                    <mat-icon class="mat-icon mat-icon-sm">check_box_outline_blank</mat-icon>
                  </ion-col>
                }
              </ion-row>
            </ion-grid>
          </ion-col>
        </ion-row>

        <ion-row class="form-field ion-margin-top">
          <ion-col class="form-label horiz-checkbox" size="6">
            <span>
              {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.RECOVERY_OF_THE_PHOTOCOPY_OF_THE_LOGBOOK' | translate }}
              <br />
              <span class="tips">
                {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.RECOVERY_OF_THE_PHOTOCOPY_OF_THE_LOGBOOK_TIPS' | translate }}
              </span>
            </span>
            <mat-icon class="mat-icon mat-icon-sm">check_box_outline_blank</mat-icon>
          </ion-col>
          <ion-col class="form-label horiz-checkbox" size="6">
            <span>
              {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.RETURN_TO_BOSS' | translate }}
              <br />
              <span class="tips">
                {{ 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.LABELS.RETURN_TO_BOSS_TIPS' | translate }}
              </span>
            </span>
            <mat-icon class="mat-icon mat-icon-sm">check_box_outline_blank</mat-icon>
          </ion-col>
        </ion-row>
      </ion-grid>

      <ion-grid class="report-section">
        <ion-row class="section-title">
          <ion-col>
            <h3>{{ 'TRIP.REPORT.FORM.COMMON.COMMENTS' | translate }}</h3>
          </ion-col>
        </ion-row>
        <ion-row class="form-field" [style.--form-field-height]="'120px'">
          <ion-col class="form-value" size="12"></ion-col>
        </ion-row>
      </ion-grid>

      <ng-content *ngTemplateOutlet="pageFooter; context: { tips: 'TRIP.REPORT.FORM.PAGE_TRIP_SHEET.TIPS' }"></ng-content>
    </section>

    @for (ops of data.operations | splitArrayInChunks: maxLinePeerTable; track $index) {
      <section *sectionDef class="landscape">
        <ng-content *ngTemplateOutlet="pageHeader; context: { title: 'TRIP.REPORT.FORM.OP_RECTO.TITLE' }"></ng-content>
        <ion-grid class="report-section ion-no-padding">
          <ion-row class="section-title ion-no-margin">
            <ion-col size="auto">
              <h3>{{ 'TRIP.REPORT.FORM.OP_RECTO.SECTION_TITLE.TRIP_NB_OP' | translate }}</h3>
            </ion-col>
            <ion-col class="title-value" size="auto"></ion-col>
          </ion-row>
        </ion-grid>
        <table>
          <thead>
            <tr class="group-head">
              <th colspan="5"></th>
              <th colspan="2" class="font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.PARENT' | translate }}</div>
              </th>
              <th colspan="2" class="font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.CHILD' | translate }}</div>
              </th>
            </tr>
            <tr>
              <th class="col-tiny font-medium text-vertical">
                <div>{{ 'TRIP.REPORT.FORM.COMMON.NUM_OP' | translate }}</div>
              </th>
              <th class="col-tiny font-small text-vertical">
                <div class="text-vertical">{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.ECH_ON' | translate }}</div>
              </th>
              <th class="col-tiny font-small text-vertical">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.PROGRESS' | translate }}</div>
              </th>
              <th class="col-extra-large font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.GEAR_SPECIES' | translate }}</div>
              </th>
              <th class="col-small font-small text-vertical">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.CAPTURE' | translate }}</div>
              </th>
              <th class="col-compact font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.COMMON.DATE_TIME' | translate }}</div>
              </th>
              <th class="col-medium font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.LAT_LONG_LOCATION' | translate }}</div>
              </th>
              <th class="col-compact font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.COMMON.DATE_TIME' | translate }}</div>
              </th>
              <th class="col-medium font-medium ion-text-center">
                <div>{{ 'TRIP.REPORT.FORM.OP_RECTO.TABLE.LAT_LONG_LOCATION' | translate }}</div>
              </th>
            </tr>
          </thead>
          <tbody>
            @for (op of ops; track $index) {
              <tr>
                <td class="col-tiny ion-text-center font-medium">
                  <div>
                    <b>{{ op.id }}</b>
                  </div>
                </td>
                <td class="col-tiny ion-text-center">
                  <div></div>
                </td>
                <td class="col-tiny ion-text-center">
                  <div></div>
                </td>
                <td class="col-extra-large">
                  <div></div>
                </td>
                <td class="col-tiny ion-text-center">
                  <div></div>
                </td>
                <td class="col-compact">
                  <div></div>
                </td>
                <td class="col-medium">
                  <div>
                    @if (isBlankForm) {
                      <span class="font-large place-holder">
                        <span [style.letter-spacing]="'3px'">__°__.___</span>
                        N
                        <br />
                        <span [style.letter-spacing]="'3px'">__°__.___</span>
                        E ou W
                      </span>
                    }
                  </div>
                </td>
                <td class="col-compact">
                  <div></div>
                </td>
                <td class="col-medium">
                  <div>
                    @if (isBlankForm) {
                      <span class="font-large place-holder">
                        <span [style.letter-spacing]="'3px'">__°__.___</span>
                        N
                        <br />
                        <span [style.letter-spacing]="'3px'">__°__.___</span>
                        E ou W
                      </span>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
          <tfoot></tfoot>
        </table>
        <ul class="caption" [style.margin-top]="'10px'">
          <li>* : {{ 'TRIP.REPORT.FORM.OP_RECTO.CAPTION.ONE_STAR' | translate }}</li>
          <li>** : {{ 'TRIP.REPORT.FORM.OP_RECTO.CAPTION.TWO_STAR' | translate }}</li>
          <li>1 : {{ 'TRIP.REPORT.FORM.OP_RECTO.CAPTION.ONE' | translate }}</li>
          <li>2 : {{ 'TRIP.REPORT.FORM.OP_RECTO.CAPTION.TWO' | translate }}</li>
          <li>3 : {{ 'TRIP.REPORT.FORM.OP_RECTO.CAPTION.THREE' | translate }}</li>
        </ul>
        <ng-content *ngTemplateOutlet="pageFooter"></ng-content>
      </section>

      <section *sectionDef class="landscape">
        <ng-content *ngTemplateOutlet="pageHeader; context: { title: 'TRIP.REPORT.FORM.OP_VERSO.TITLE' }"></ng-content>
        <table class="table-full-width" [style.margin-top]="'50px'">
          <thead>
            <tr>
              <th class="col-tiny font-medium text-vertical">
                <div>{{ 'TRIP.REPORT.FORM.COMMON.NUM_OP' | translate }}</div>
              </th>
              <th class="col-maximum font-medium">
                <div>{{ 'TRIP.REPORT.FORM.OP_VERSO.TABLE.COMMENTS' | translate }}</div>
              </th>
            </tr>
          </thead>
          <tbody>
            @for (op of ops; track $index) {
              <tr>
                <td class="col-tiny ion-text-center">
                  <div>
                    <b>{{ op.id }}</b>
                  </div>
                </td>
                <td class="col-maximum ion-text-right">
                  <div>{{ op.comments }}</div>
                </td>
              </tr>
            }
          </tbody>
          <tfoot></tfoot>
        </table>
        <ng-content *ngTemplateOutlet="pageFooter"></ng-content>
      </section>
    }

    <ng-container *ngFor="let ops of data.operations | splitArrayInChunks: maxLinePeerTable; index as mainIndex">
      <section *sectionDef class="portrait">
        <ng-content *ngTemplateOutlet="pageHeader; context: { title: 'TRIP.REPORT.FORM.GEARS_CARD_1.TITLE' }"></ng-content>
        <ion-grid class="page-body"></ion-grid>
        <ng-content *ngTemplateOutlet="pageFooter"></ng-content>
      </section>
    </ng-container>
  </app-reveal>

  <ng-template #pageHeader let-title="title">
    <ion-grid class="report-header ion-no-padding">
      <ion-row class="page-title">
        <ion-col class="logo" size="auto">
          @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
            <img [src]="stats.logoHeadLeftUrl" />
          }
        </ion-col>
        <ion-col>
          <ion-grid class="ion-no-padding">
            <ion-row class="title-items">
              <ion-col size="auto">
                {{ 'TRIP.REPORT.FORM.COMMON.TRIP_DEPARTURE_DATE_TIME' | translate }} :
                <span *ngIf="isBlankForm">...../...../......</span>
              </ion-col>
              <ion-col size="auto">
                {{ 'TRIP.REPORT.FORM.COMMON.VESSEL_NAME' | translate }} :
                <span *ngIf="isBlankForm">.................................</span>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-col>
        <ion-col>
          <h2>{{ title | translate }}</h2>
        </ion-col>
        <ion-col class="logo" size="auto">
          @if (stats?.logoHeadLeftUrl | isNotNilOrBlank) {
            <img [src]="stats.logoHeadRightUrl" />
          }
        </ion-col>
      </ion-row>
    </ion-grid>
  </ng-template>

  <ng-template #pageFooter let-tips="tips">
    <ion-grid class="report-footer ion-no-padding">
      @if (tips | isNotNilOrBlank) {
        <ion-row class="footer-tips">
          <ion-col>
            {{ tips | translate }}
          </ion-col>
        </ion-row>
      }
      <ion-row class="footer-text">
        <ion-col [innerHTML]="stats.footerText"></ion-col>
      </ion-row>
    </ion-grid>
  </ng-template>

  <ng-template #loadingTemplate>
    <div class="loader">
      <ion-spinner slot="start" color="secondary" size="large"></ion-spinner>
    </div>
  </ng-template>
</ion-content>
