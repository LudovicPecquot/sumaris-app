<!-- main toolbar -->
<mat-toolbar [class.expanded]="filterExpansionPanel.expanded">
  <button mat-icon-button (click)="filterExpansionPanel.toggle()">
    <mat-icon slot="icon-only"
              [matBadge]="'!'"
              [matBadgeHidden]="valid"
              matBadgeOverlap="false"
              matBadgeColor="accent"
              matBadgeSize="small"
              matBadgePosition="above after">account_tree</mat-icon>
  </button>

  <ng-container *ngIf="filterExpansionPanel.closed && editingBatch; let node else helpMessage">
    <ng-container *ngIf="node.parent">
      <ion-text  [class.cdk-visually-hidden]="node.parent.hidden" color="dark">&nbsp;&gt;&nbsp;</ion-text>
      <button mat-button
              *ngIf="!node.parent.hidden"
              [title]="node.validator|translateFormError: errorTranslatorOptions"
              [matMenuTriggerFor]="childrenMenu"
              [matMenuTriggerData]="{node: node.parent.parent, selected: node.parent}">
        <span [matBadge]="'!'"
              [matBadgeHidden]="node.parent.valid"
              matBadgeOverlap="false"
              matBadgeColor="accent"
              matBadgeSize="small"
              matBadgePosition="above after">{{node.parent.name}}</span>
      </button>
    </ng-container>

    <ion-text color="dark">&gt;</ion-text>

    <!-- current batch name -->
    <button mat-button
            [matMenuTriggerFor]="childrenMenu"
            [matMenuTriggerData]="{node: editingBatch.parent}">
      <span [matBadge]="'!'"
            [matBadgeHidden]="batchTree.valid"
            matBadgeOverlap="false"
            matBadgeColor="accent"
            matBadgeSize="small"
            matBadgePosition="above after">{{editingBatch.name}}</span>
    </button>

    <ng-container *ngIf="!node.isLeaf">
      <ion-text color="dark">&gt;</ion-text>

      <!-- Children menu -->
      <button mat-button
              [matMenuTriggerFor]="childrenMenu"
              [matMenuTriggerData]="{node: editingBatch}">
        <span>...</span>
      </button>
    </ng-container>
  </ng-container>
  <ng-template #helpMessage>
    <ion-item color="transparent" class="ion-padding-start" lines="none">
      <ion-icon color="primary" name="help-circle-outline"></ion-icon>
      <ion-label color="primary" class="text-italic" [innerHTML]="'TRIP.BATCH.TREE.SELECT_PARENT_HELP'|translate"></ion-label>
    </ion-item>
  </ng-template>

  <div class="toolbar-spacer"></div>

  <!-- navigation buttons -->
  <button mat-icon-button
          [class.cdk-visually-hidden]="!editingBatch"
          (click)="backward($event)"
          [title]="'COMMON.BTN_PREVIOUS'|translate">
    <ion-icon slot="icon-only" name="chevron-back-circle-outline"></ion-icon>
  </button>
  <button mat-icon-button
          [class.cdk-visually-hidden]="!editingBatch"
          (click)="forward($event)"
          [title]="'COMMON.BTN_NEXT'|translate">
    <ion-icon slot="icon-only" name="chevron-forward-circle-outline"></ion-icon>
  </button>
  <button mat-icon-button (click)="openFilterPanel($event)">
    <mat-icon>filter_list_alt</mat-icon>
  </button>
</mat-toolbar>


<!-- Brother batches menu -->
<mat-menu #brothersMenu="matMenu" xPosition="after">
  <ng-template matMenuContent let-node="node">
    <button *ngFor="let item of node.brothers" mat-menu-item
            (click)="startEditBatch(null, item)">
      <app-icon *ngIf="item.icon" [ref]="item.icon"></app-icon>
      <span>{{item.name}}</span>
    </button>
  </ng-template>
</mat-menu>

<!-- Children batches menu -->
<mat-menu #childrenMenu="matMenu" xPosition="after">
  <ng-template matMenuContent let-node="node" let-selected="selected">
    <button *ngFor="let item of node.children" mat-menu-item
            [class.activated]="item.editing || item === selected"
            (click)="startEditBatch(null, item)">
      <app-icon *ngIf="item.icon" [ref]="item.icon"></app-icon>
      <span [matBadge]="'!'"
            [matBadgeHidden]="item.valid"
            matBadgeOverlap="false"
            matBadgeColor="accent"
            matBadgeSize="small"
            matBadgePosition="above after">{{item.name}}</span>
    </button>
  </ng-template>
</mat-menu>


<div class="form-container" [class.has-toolbar]="showToolbar">
  <!-- filter panel -->
  <mat-expansion-panel #filterExpansionPanel
                       class="filter-panel ion-no-padding"
                       [class.ion-no-padding]="mobile"
                       [class.filter-panel-floating]="filterPanelFloating">

    <!-- batch tree -->
    <ion-list class="ion-no-padding">
      <mat-tree [dataSource]="treeDataSource"
                [treeControl]="treeControl"
                class="batch-tree">
        <!-- Expandable nodes -->
        <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" >
          <li>
            <ion-item (click)="startEditBatch($event, node)"
                      [class.cdk-visually-hidden]="node.hidden"
                      [class.activated]="editingBatch === node"
                      [disabled]="node.disabled"
                      tappable>
              <mat-icon class="mat-icon-rtl-mirror" matTreeNodeToggle>
                {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
              </mat-icon>

              <!-- name -->
              <ion-label>
                <h2>{{node.name}}</h2>
                <p *ngIf="submitted && (node.validator | translateFormError: errorTranslatorOptions); let error"
                   [class.cdk-visually-hidden]="!error">
                  <ion-text color="danger" [innerHTML]="error"></ion-text>
                </p>
              </ion-label>

              <!-- badges -->
              <ion-buttons slot="end">
                <ng-container *ngTemplateOutlet="batchBadges; context: {$implicit: node}"></ng-container>
              </ion-buttons>
  <!--            &lt;!&ndash; has weight pmfms &ndash;&gt;-->
  <!--            <mat-icon class="small-icon" slot="end" *ngIf="node.pmfms|arrayFilter:isWeightPmfm|isNotEmptyArray">scale</mat-icon>-->
  <!--            &lt;!&ndash; has error pmfms &ndash;&gt;-->
  <!--            <ion-icon *ngIf="node === editingBatch && (batchTree.errorSubject | async) || node.error || node.invalid; let error"-->
  <!--                      class="small-icon" slot="end" name="alert-circle" color="danger"-->
  <!--                      [title]="error||''"></ion-icon>-->
              <ion-icon name="chevron-forward-outline" slot="end" *ngIf="!node.disabled"></ion-icon>
            </ion-item>
            <ul [class.ion-no-padding]="node.hidden"
                [class.cdk-visually-hidden]="!treeControl.isExpanded(node)">
              <ng-container matTreeNodeOutlet></ng-container>
            </ul>
          </li>
        </mat-nested-tree-node>

        <!-- Leaf nodes -->
        <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
          <li>

            <ion-item (click)="startEditBatch($event, node)"
                      [class.activated]="node === editingBatch"
                      tappable>
              <!-- spacer for alignment -->
              <mat-icon [style.width.px]="8"></mat-icon>

              <!-- name + error -->
              <ion-label>
                <h2>{{node.name}}</h2>
                <p *ngVar="node.validator | translateFormError: errorTranslatorOptions; let error"
                  [class.cdk-visually-hidden]="!error">
                  <ion-icon class="small-icon" color="danger" name="alert-circle"></ion-icon>
                  <ion-text color="danger" [innerHTML]="error"></ion-text>
                </p>
              </ion-label>
              <ion-buttons slot="end">
                <ng-container *ngTemplateOutlet="batchBadges; context: {$implicit: node}"></ng-container>
              </ion-buttons>
              <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
            </ion-item>
          </li>
        </mat-tree-node>
      </mat-tree>
    </ion-list>

    <!-- filter action bar -->
    <mat-action-row>
      <div class="toolbar-spacer"></div>

      <button mat-icon-button color="accent"
              *ngIf="filterPanelFloating"
              (click)="toggleFilterPanelFloating()"
              class="hidden-xs hidden-sm hidden-md"
              [title]="(filterPanelFloating ? 'COMMON.BTN_EXPAND' : 'COMMON.BTN_HIDE') |translate">
        <mat-icon><span style="transform: rotate(90deg);">{{filterPanelFloating ? '&#xbb;' : '&#xab;'}}</span></mat-icon>
      </button>

      <!-- Close panel -->
      <ion-button mat-button fill="clear" color="dark"
                  (click)="closeFilterPanel()"
                  [disabled]="loadingSubject|async">
        <ion-text translate>COMMON.BTN_CLOSE</ion-text>
      </ion-button>
    </mat-action-row>
  </mat-expansion-panel>

  <!-- batch item -->
  <ng-template #batchBadges let-node>

    <ng-container *ngIf="debug">
      <!-- editing (=enabled) -->
      <ion-badge *ngIf="node.editing" color="success"
                 slot="end">enabled</ion-badge>
      <ion-badge *ngIf="!node.editing" color="light"
                 slot="end">disabled</ion-badge>

      <!--  invalid -->
      <ion-badge *ngIf="node.invalid" color="danger"
                 slot="end">invalid</ion-badge>

      <!-- pmfm count
      <ion-badge *ngIf="node.pmfms?.length; let count"
                 color="secondary"
                 slot="end">{{count}} pmfms</ion-badge> -->
      &nbsp;
      <!-- table pmfm count
      <ion-badge color="secondary" slot="end"
                 *ngIf="node.childrenPmfms?.length; let count;"
                 [title]="node.childrenPmfms|arrayPluck:'label'">{{count}} columns</ion-badge>-->
      &nbsp;
      <!-- has weight pmfms
      <mat-icon class="small-icon" slot="end" *ngIf="node.pmfms|arrayFilter:isWeightPmfm|isNotEmptyArray">scale</mat-icon>-->
    </ng-container>

    <!-- for leaf node -->
    <ng-container *ngIf="node.isLeaf">
      <ion-badge *ngIf="node===editingBatch ? batchTree.batchGroupsTable?.totalRowCount : node.currentData.children?.length; let rowCount"
                 [color]="rowCount ? 'tertiary' : 'warning'"
                 slot="end">{{(rowCount === 1 ? 'TRIP.BATCH.TREE.BATCH_COUNT' : 'TRIP.BATCH.TREE.BATCHES_COUNT') | translate:{rowCount: rowCount} }}
      </ion-badge>
    </ng-container>

    <!-- has error
    <ion-icon *ngIf="node.invalid"
              class="small-icon" slot="end" name="alert-circle" color="danger"
              [title]="error||''"></ion-icon> -->

  <!--  <ion-button size="small" color="tertiary"-->
  <!--              [matBadge]="5"-->
  <!--              [matBadgeHidden]="!5"-->
  <!--              matBadgeOverlap="false"-->
  <!--              matBadgeColor="primary"-->
  <!--              matBadgeSize="small"-->
  <!--              matBadgePosition="above after">-->
  <!--    <mat-icon slot="icon-only" svgIcon="fish"></mat-icon>-->
  <!--  </ion-button>-->
  <!--  <ion-button size="small" color="tertiary">-->
  <!--    <mat-icon slot="icon-only"-->
  <!--              [matBadge]="15"-->
  <!--              [matBadgeHidden]="!15"-->
  <!--              matBadgeOverlap="false"-->
  <!--              matBadgeColor="primary"-->
  <!--              matBadgeSize="small"-->
  <!--              matBadgePosition="above after">straighten</mat-icon>-->
  <!--  </ion-button>-->

  </ng-template>


  <app-batch-tree #batchTree
                  (ngInit)="addChildForm(batchTree)"
                  [class.cdk-visually-hidden]="!editingBatch"
                  [queryTabIndexParamName]="queryTabIndexParamName"
                  [showBatchTables]="showBatchTables"
                  [allowSamplingBatches]="allowSamplingBatches"
                  [allowSubBatches]="allowSubBatches"
                  [defaultHasSubBatches]="defaultHasSubBatches"
                  [availableTaxonGroups]="availableTaxonGroups"
                  [usageMode]="usageMode"
                  [modalOptions]="modalOptions"
                  [physicalGearId]="$physicalGearId|async"
                  [useSticky]="useSticky"
                  [i18nPmfmPrefix]="i18nPmfmPrefix"
                  [mobile]="mobile"
                  [disabled]="disabled"
                  [filter]="filter"
                  [debug]="false">
  </app-batch-tree>
</div>


<ng-template #debug>
  <app-debug title="Batch tree container">
    <ion-grid class="ion-no-padding">
      <ion-row>
        <ion-col>
          loading: {{loading}}<br/>
          ready: {{readySubject|async}}<br/>
          dirty: {{dirty}}<br/>
          value: {{!!data}}<br/>
          valid: {{valid}}<br/>
          invalid: {{invalid}}<br/>
        </ion-col>
        <ion-col *ngIf="form">
          form.dirty: {{form.dirty}}<br/>
          form.valid: {{form.valid}}<br/>
          form.invalid: {{form.invalid}}<br/>
          form.value: <br/>
          <!--        <pre><p>{{form.getRawValue()|json}}</p></pre>-->
        </ion-col>
        <ion-col>
          batchTree.loading: {{batchTree.loading}}<br/>
          batchTree.ready: {{batchTree.readySubject|async}}<br/>
          batchTree.dirty: {{batchTree.dirty}}<br/>
          batchTree.value: {{!!batchTree.data}}<br/>
          batchTree.valid: {{batchTree.valid}}<br/>
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col size="12">
          <ion-text color="danger" [innerHTML]="_form | translateFormError: errorTranslatorOptions"></ion-text>
        </ion-col>
      </ion-row>
    </ion-grid>
  </app-debug>
</ng-template>
