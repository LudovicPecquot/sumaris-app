<!-- debug -->
<app-debug *ngIf="debug" title="Batch tree container">
  <ion-grid class="ion-no-padding">
    <ion-row>
      <ion-col>
        loading: {{loading}}<br/>
        ready: {{readySubject|async}}<br/>
        dirty: {{dirty}}<br/>
        value: {{!!data}}<br/>
      </ion-col>
      <ion-col *ngIf="filterForm">
        filterForm.valid: {{filterForm.valid}}<br/>
        filterForm.invalid: {{filterForm.invalid}}<br/>
        filterForm.dirty: {{filterForm.dirty}}<br/>
        <!--filterForm.value: {{filterForm.valueChanges|async|json}}<br/>-->
      </ion-col>
      <ion-col>
        batchTree.loading: {{batchTree.loading}}<br/>
        batchTree.ready: {{batchTree.readySubject|async}}<br/>
        batchTree.dirty: {{batchTree.dirty}}<br/>
        batchTree.value: {{!!batchTree.data}}<br/>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="12">
        <ion-text color="danger" [innerHTML]="filterForm | translateFormError: errorTranslatorOptions"></ion-text>
      </ion-col>
    </ion-row>
  </ion-grid>
</app-debug>

<!-- filter panel -->
<mat-expansion-panel #filterExpansionPanel
                     class="filter-panel ion-no-padding"
                     [class.ion-no-padding]="mobile"
                     [class.filter-panel-floating]="filterPanelFloating">
  <mat-expansion-panel-header>
    <ion-item lines="none">
      <ion-buttons slot="start">
        <mat-icon slot="icon-only"
                  [matBadge]="'!'"
                  [matBadgeHidden]="filterForm?.valid"
                  matBadgeOverlap="false"
                  matBadgeColor="accent"
                  matBadgeSize="small"
                  matBadgePosition="above after"
                  >account_tree</mat-icon>
      </ion-buttons>

      <ng-container *ngIf="!filterExpansionPanel.expanded && editingBatch; else helpMessage">
        <ion-buttons slot="start">
          <ng-container *ngIf="editingBatch.parentModel; let parent">
            <ion-text  [class.cdk-visually-hidden]="parent.hidden" color="dark">&gt;</ion-text>
            <ion-button *ngIf="filterForm|formGetGroup:parent.path; let parentForm"
                        [class.cdk-visually-hidden]="parent.hidden"
                        (click)="editBatch($event, parent)">
              <ion-label>{{(parent.name || parent.label) | translate}}</ion-label>
              <ion-icon *ngIf="parentForm.invalid" class="small-icon" color="danger" name="alert-circle"></ion-icon>
            </ion-button>
          </ng-container>

          <ion-text color="dark">&gt;</ion-text>

          <!-- current batch name -->
          <ion-button>
            <ion-label translate>{{editingBatch.name || editingBatch.label}}</ion-label>
            <ion-icon *ngIf="editingBatch.invalid" class="small-icon" color="danger" name="alert-circle"></ion-icon>
          </ion-button>

        </ion-buttons>

        <ion-buttons slot="end">
          <ng-container *ngTemplateOutlet="batchBadges; context: {$implicit: editingBatch}"></ng-container>
        </ion-buttons>
      </ng-container>
      <ng-template #helpMessage>
        <ion-label color="primary">
          <ion-icon name="help-circle-outline"></ion-icon>
          <ion-text class="text-italic" [innerHTML]="'TRIP.BATCH.TREE.SELECT_PARENT_HELP'|translate"></ion-text>
        </ion-label>
      </ng-template>
    </ion-item>
  </mat-expansion-panel-header>

  <!-- batch tree -->
  <ion-list class="ion-no-padding">
    <mat-tree [dataSource]="treeDataSource"
              [treeControl]="treeControl"
              class="batch-tree">
      <!-- Expandable nodes -->
      <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" >
        <li>
          <ion-item (click)="editBatch($event, node)"
                    [class.cdk-visually-hidden]="node.hidden"
                    [class.activated]="editingBatch === node"
                    [disabled]="node.disabled"
                    tappable>
            <mat-icon class="mat-icon-rtl-mirror" matTreeNodeToggle>
              {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
            </mat-icon>
            <ion-label>
              <h2 translate>{{node.name || node.label}}</h2>
              <p *ngVar="node.form | translateFormError: errorTranslatorOptions; let error"
                 [class.cdk-visually-hidden]="!error">
                <ion-text color="danger" [innerHTML]="error"></ion-text>
              </p>
            </ion-label>
            <ion-buttons slot="end">
              <ng-container *ngTemplateOutlet="batchBadges; context: {$implicit: node}"></ng-container>
            </ion-buttons>
<!--            &lt;!&ndash; has weight pmfms &ndash;&gt;-->
<!--            <mat-icon class="small-icon" slot="end" *ngIf="node.pmfms|arrayFilter:isWeightPmfm|isNotEmptyArray">scale</mat-icon>-->
<!--            &lt;!&ndash; has error pmfms &ndash;&gt;-->
<!--            <ion-icon *ngIf="node === editingBatch && (batchTree.errorSubject | async) || node.error || node.invalid; let error"-->
<!--                      class="small-icon" slot="end" name="alert-circle" color="danger"-->
<!--                      [title]="error||''"></ion-icon>-->
            <ion-icon name="chevron-forward-outline" slot="end" *ngIf="!node.disabled"></ion-icon>
          </ion-item>
          <ul [class.ion-no-padding]="node.hidden"
              [class.cdk-visually-hidden]="!treeControl.isExpanded(node)">
            <ng-container matTreeNodeOutlet></ng-container>
          </ul>
        </li>
      </mat-nested-tree-node>

      <!-- Leaf nodes -->
      <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
        <li>

          <ion-item (click)="editBatch($event, node)"
                    [class.activated]="node === editingBatch"
                    tappable>
            <mat-icon [style.width.px]="8"></mat-icon><!-- spacer for alignment -->
            <ion-label>
              <h2 translate>{{node.name || node.label}}</h2>
              <p *ngVar="node.form | translateFormError: errorTranslatorOptions; let error"
                [class.cdk-visually-hidden]="!error">
                <ion-icon class="small-icon" color="danger" name="alert-circle"></ion-icon>
                <ion-text color="danger" [innerHTML]="error"></ion-text>
              </p>
            </ion-label>
            <ion-buttons slot="end">
              <ng-container *ngTemplateOutlet="batchBadges; context: {$implicit: node}"></ng-container>
            </ion-buttons>
            <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
          </ion-item>
        </li>
      </mat-tree-node>
    </mat-tree>
  </ion-list>

  <!-- filter action bar -->
  <mat-action-row>
    <div class="toolbar-spacer"></div>

    <button mat-icon-button color="accent"
            *ngIf="filterPanelFloating"
            (click)="toggleFilterPanelFloating()"
            class="hidden-xs hidden-sm hidden-md"
            [title]="(filterPanelFloating ? 'COMMON.BTN_EXPAND' : 'COMMON.BTN_HIDE') |translate">
      <mat-icon><span style="transform: rotate(90deg);">{{filterPanelFloating ? '&#xbb;' : '&#xab;'}}</span></mat-icon>
    </button>

    <!-- Close panel -->
    <ion-button mat-button fill="clear" color="dark"
                (click)="closeFilterPanel()"
                [disabled]="loadingSubject|async">
      <ion-text translate>COMMON.BTN_CLOSE</ion-text>
    </ion-button>
  </mat-action-row>
</mat-expansion-panel>

<!-- batch item -->
<ng-template #batchBadges let-node>

  <ng-container *ngIf="debug">
    <!-- pmfm count -->
    <ion-badge *ngIf="node.pmfms?.length; let count"
               color="secondary"
               slot="end">{{count}} pmfms</ion-badge>
    &nbsp;
    <!-- table pmfm count  -->
    <ng-container *ngIf="node.childrenPmfms?.length; let count;">
      <ion-badge color="secondary" slot="end" [title]="node.childrenPmfms|arrayPluck:'label'">{{count}} columns</ion-badge>
      &nbsp;
    </ng-container>
    <!-- has weight pmfms
    <mat-icon class="small-icon" slot="end" *ngIf="node.pmfms|arrayFilter:isWeightPmfm|isNotEmptyArray">scale</mat-icon>-->
  </ng-container>

  <ng-container *ngIf="node === editingBatch; else notEditingBatch">
    <ion-badge *ngIf="node.childrenPmfms?.length"
               color="tertiary"
               slot="end">{{batchTree.batchGroupsTable?.totalRowCount || 0}} lots</ion-badge>
  </ng-container>
  <ng-template #notEditingBatch>
    <ion-badge *ngIf="node.childrenPmfms?.length"
               color="tertiary"
               slot="end">{{node.children?.length || 0}} lots</ion-badge>
  </ng-template>

  <!-- has error pmfms
  <ion-icon *ngIf="node.invalid"
            class="small-icon" slot="end" name="alert-circle" color="danger"
            [title]="error||''"></ion-icon> -->

<!--  <ion-button size="small" color="tertiary"-->
<!--              [matBadge]="5"-->
<!--              [matBadgeHidden]="!5"-->
<!--              matBadgeOverlap="false"-->
<!--              matBadgeColor="primary"-->
<!--              matBadgeSize="small"-->
<!--              matBadgePosition="above after">-->
<!--    <mat-icon slot="icon-only" svgIcon="fish"></mat-icon>-->
<!--  </ion-button>-->
<!--  <ion-button size="small" color="tertiary">-->
<!--    <mat-icon slot="icon-only"-->
<!--              [matBadge]="15"-->
<!--              [matBadgeHidden]="!15"-->
<!--              matBadgeOverlap="false"-->
<!--              matBadgeColor="primary"-->
<!--              matBadgeSize="small"-->
<!--              matBadgePosition="above after">straighten</mat-icon>-->
<!--  </ion-button>-->
</ng-template>


<ng-template #batchLabel let-node let-displayParent="displayParent">
  <ion-label>
    <!-- parent name -->
    <span *ngIf="displayParent && node['parent']; let parent"
          [class.cdk-visually-hidden]="parent['hidden']">{{(parent.name || parent.label) | translate}} > </span>
    <!-- batch name -->
    <span [class.text-bold]="displayParent">{{(node.name || node.label)|translate}}</span>
  </ion-label>
</ng-template>

<app-batch-tree #batchTree
                (ngInit)="addChildForm(batchTree)"
                [class.cdk-visually-hidden]="!editingBatch"
                [queryTabIndexParamName]="queryTabIndexParamName"
                [showBatchTables]="showBatchTables"
                [allowSamplingBatches]="allowSamplingBatches"
                [allowSubBatches]="allowSubBatches"
                [defaultHasSubBatches]="defaultHasSubBatches"
                [availableTaxonGroups]="availableTaxonGroups"
                [usageMode]="usageMode"
                [modalOptions]="modalOptions"
                [physicalGearId]="$physicalGearId|async"
                [useSticky]="useSticky"
                [i18nPmfmPrefix]="i18nPmfmPrefix"
                [mobile]="mobile"
                [disabled]="disabled"
                [filter]="filter"
                [debug]="debug">
</app-batch-tree>
