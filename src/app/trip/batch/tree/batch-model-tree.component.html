
<!-- batch tree -->
<ion-list class="ion-no-padding">
  <mat-tree [dataSource]="treeDataSource"
            [treeControl]="treeControl"
            class="batch-tree">
    <!-- Expandable nodes -->
    <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild" >
      <li *ngVar="treeControl.isExpanded(node) as expanded">
        <ion-item (click)="click($event, node)"
                  [class.activated]="selected===node"
                  [disabled]="node.disabled"
                  [class.cdk-visually-hidden]="node.hidden"
                  tappable>
          <button mat-icon-button slot="start" (click)="toggle($event, node)">
            <mat-icon class="mat-icon-rtl-mirror">{{expanded ? 'expand_more' : 'chevron_right'}}</mat-icon>
          </button>

          <!-- name -->
          <ion-label>
            <h2>
              <span matBadge="!"
                    [matBadgeHidden]="node.valid"
                    matBadgeOverlap="false"
                    matBadgeColor="accent"
                    matBadgeSize="small"
                    matBadgePosition="above after">{{node.name}}</span>
            </h2>
          </ion-label>

          <!-- badges -->
          <ion-buttons slot="end">
            <ng-container *ngTemplateOutlet="expandableBadges; context: {$implicit: node}"></ng-container>
          </ion-buttons>

          <ion-icon name="chevron-forward-outline" slot="end" *ngIf="mobile && !node.disabled"></ion-icon>

        </ion-item>
        <ul [class.ion-no-padding]="node.hidden"
            [class.cdk-visually-hidden]="!treeControl.isExpanded(node)">
          <ng-container matTreeNodeOutlet></ng-container>
        </ul>
      </li>
    </mat-nested-tree-node>

    <!-- Leaf nodes -->
    <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
      <li>

        <ion-item (click)="click($event, node)"
                  [class.activated]="selected===node"
                  tappable>
          <!-- spacer for alignment -->
          <app-icon slot="start" [ref]="node.icon||{}"></app-icon>

          <!-- name + error -->
          <ion-label>
            <h2>
              <span matBadge="!"
                    [matBadgeHidden]="node.valid"
                    matBadgeOverlap="false"
                    matBadgeColor="accent"
                    matBadgeSize="small"
                    matBadgePosition="above after">{{node.name}}</span>
            </h2>
          </ion-label>
          <ion-buttons slot="end">
            <ng-container *ngTemplateOutlet="leafBadges; context: {$implicit: node}"></ng-container>
          </ion-buttons>

          <ion-icon name="chevron-forward-outline" slot="end" *ngIf="mobile"></ion-icon>
        </ion-item>
      </li>
    </mat-tree-node>
  </mat-tree>
</ion-list>


<!-- expandable node badges -->
<ng-template #expandableBadges let-node>

  <ng-container *ngIf="debug">
    <!-- editing (=enabled) -->
    <ion-badge *ngIf="node.editing"
               color="success" class="visible-hover" slot="end">enabled</ion-badge>
    <ion-badge *ngIf="!node.editing"
               color="light" class="visible-hover" slot="end">disabled</ion-badge>
    &nbsp;

    <!-- pmfm count  -->
    <ion-badge *ngIf="node.pmfms?.length; let count"
               slot="end" class="visible-hover" color="secondary"
               >{{count}} pmfms</ion-badge>
    &nbsp;
  </ng-container>

  <!-- expanded node -->
  <ng-container *ngIf="node.isExpanded; else leafBadges">
    <!-- weight pmfms count -->
    <ion-badge *ngIf="(node.pmfms|arrayFilter:isNotHiddenPmfm)?.length; let count"
               [color]="node.valid ? 'success' : 'danger'"
               slot="end">{{count}}
    </ion-badge>
  </ng-container>

</ng-template>

<!-- leaf nodes badges -->
<ng-template #leafBadges let-node>
  <ng-container *ngIf="debug">
    <!-- editing (=enabled) -->
    <ion-badge *ngIf="node.editing"
               color="success" class="visible-hover" slot="end">enabled</ion-badge>
    <ion-badge *ngIf="!node.editing"
               color="light" class="visible-hover" slot="end">disabled</ion-badge>
    &nbsp;

    <!-- table pmfm count  -->
    <ion-badge *ngIf="node.childrenPmfms?.length; let count;"
               color="secondary" slot="end" class="visible-hover"
               [title]="node.childrenPmfms|arrayPluck:'label'">{{count}} col</ion-badge>
    &nbsp;&nbsp;
  </ng-container>

  <!-- batches count -->
  <ion-badge *ngIf="selected === node ? currentRowCount : node.rowCount; let count; else emptyLeaf"
             color="success"
             slot="end">{{count}}
  </ion-badge>

  <!-- empty -->
  <ng-template #emptyLeaf>
    <ion-badge color="medium" slot="end">0</ion-badge>
  </ng-template>
</ng-template>
