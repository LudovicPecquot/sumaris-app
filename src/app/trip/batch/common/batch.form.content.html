<form class="form-container" [formGroup]="parent.form" (ngSubmit)="parent.doSubmit($event)" >

  <!-- error -->
  <ion-item *ngIf="parent.error && parent.showError" visible-xs visible-sm visible-mobile lines="none">
    <ion-icon color="danger" slot="start" name="alert-circle"></ion-icon>
    <ion-label color="danger" class="error" [innerHTML]="parent.error|translate"></ion-label>
  </ion-item>

  <!-- DEBUG -->
  <ng-container *ngIf="parent.debug">
    <ng-container *ngTemplateOutlet="debugPanel"></ng-container>
  </ng-container>

  <ion-grid class="ion-no-padding">
    <ion-row>

      <!-- Taxon group -->
      <ion-col size="12" size-md="6" *ngIf="parent.showTaxonGroup">
        <mat-autocomplete-field formControlName="taxonGroup"
                                [autofocus]="parent.enabled && !parent.mobile"
                                [placeholder]="'TRIP.BATCH.EDIT.TAXON_GROUP'|translate"
                                [tabindex]="parent.showTaxonGroup ? parent.tabindex : -1"
                                [required]="parent.showTaxonGroup"
                                [config]="parent.autocompleteFields.taxonGroup"
                                [showSearchBar]="!parent.autocompleteFields.taxonGroup.items">
        </mat-autocomplete-field>
      </ion-col>

      <!-- Taxon name (scientific species) -->
      <ion-col size="12" size-md="6" *ngIf="parent.showTaxonName">
        <mat-autocomplete-field formControlName="taxonName"
                                [autofocus]="parent.enabled && !parent.mobile && !parent.showTaxonGroup && parent.showTaxonName"
                                [placeholder]="'TRIP.BATCH.EDIT.TAXON_NAME'|translate"
                                [tabindex]="parent.tabindex+1"
                                [required]="parent.showTaxonName"
                                [config]="parent.autocompleteFields.taxonName"
                                [filter]="parent.taxonNameFilter">
        </mat-autocomplete-field>
      </ion-col>
    </ion-row>

    <!-- Measurements -->
    <ion-row class="ion-no-padding" [formGroup]="parent.measurementValuesForm">
      <ion-col *ngFor="let pmfm of parent.$pmfms | async; trackBy: parent.trackPmfmFn; index as i;"
               size="12" size-md="6" class="ion-no-padding">
        <app-pmfm-field #matInput [pmfm]="pmfm"
                        [hidden]="pmfm.hidden || matInput.formControl?.disabled"
                        [controlName]="pmfm|pmfmIdString"
                        [style]="pmfm|pmfmFieldStyle:parent.maxVisibleButtons"
                        [compact]="parent.compact"
                        [tabindex]="parent.tabindex+2 + i*2"
                        [maxVisibleButtons]="parent.maxVisibleButtons">
        </app-pmfm-field>
      </ion-col>
    </ion-row>

    <!-- Total weight -->
    <ion-row *ngIf="parent.defaultWeightPmfm && parent.showWeight">
      <ion-col class="ion-no-padding">
        <app-pmfm-field [class.computed]="(parent.form|formGetControl: 'weight.computed').value"
                        [readonly]="(parent.form|formGetControl: 'weight.computed').value"
                        [pmfm]="parent.defaultWeightPmfm"
                        [formControl]="parent.form|formGetControl: 'weight.value'"
                        [placeholder]="'TRIP.BATCH.EDIT.TOTAL_WEIGHT'|translate"
                        [compact]="parent.compact"
                        [tabindex]="parent.tabindex+28"
                        [listenStatusChanges]="true">
        </app-pmfm-field>
      </ion-col>

      <!-- is estimated weight ?-->
      <ion-col size="6" class="ion-no-padding" padding-left *ngIf="parent.showEstimatedWeight">

        <mat-form-field floatLabel="never">
          <!-- fake input -->
          <input matInput hidden>

          <ion-label>&nbsp;</ion-label>

          <!-- checkbox, when compact -->
          <mat-checkbox matPrefix
                        [formControl]="parent.form|formGetControl:'weight.estimated'"
                        labelPosition="after"
                        [tabIndex]="parent.tabindex+29">
            <ion-text translate>TRIP.BATCH.EDIT.ESTIMATED_WEIGHT</ion-text>
          </mat-checkbox>
        </mat-form-field>

      </ion-col>
    </ion-row>

    <!-- Total NB individual  -->
    <ion-row class="ion-no-padding" *ngIf="parent.showIndividualCount">
      <ion-col class="ion-no-padding">
        <mat-form-field>
          <input matInput
                 formControlName="individualCount"
                 autocomplete="off"
                 type="number"
                 step="1"
                 pattern="[0-9]*"
                 (click)="parent.selectInputContent($event)"
                 [placeholder]="'TRIP.BATCH.EDIT.TOTAL_INDIVIDUAL_COUNT'|translate"
                 [tabindex]="parent.tabindex + 30"
                 [required]="parent.requiredIndividualCount">

          <mat-error *ngIf="parent.form.controls.individualCount.hasError('required')" translate>ERROR.FIELD_REQUIRED</mat-error>
          <mat-error *ngIf="parent.form.controls.individualCount.hasError('min')">
            {{(parent.compact ? 'ERROR.FIELD_MIN_COMPACT' : 'ERROR.FIELD_MIN') | translate:parent.form.controls.individualCount.errors['min'] }}</mat-error>
          <mat-error *ngIf="parent.form.controls.individualCount.hasError('integer')">
            {{'ERROR.FIELD_NOT_VALID_INTEGER'| translate }}</mat-error>
        </mat-form-field>
      </ion-col>
    </ion-row>

    <!-- Sampling batch -->
    <div formArrayName="children" [class.cdk-visually-hidden]="!parent.showSamplingBatch">
      <ion-row class="ion-no-padding" [class.cdk-visually-hidden]="parent.requiredSampleWeight">
        <ion-col class="ion-no-padding">
          <!-- checkbox, when compact -->
          <mat-checkbox [checked]="parent.isSampling"
                        [disabled]="parent.disabled"
                        labelPosition="after"
                        [tabIndex]="parent.showSamplingBatch && !parent.requiredSampleWeight ? parent.tabindex+31 : -1"
                        (change)="parent.setIsSampling($event.checked)">
            <ion-text>{{'TRIP.BATCH.EDIT.IS_SAMPLING'|translate}}</ion-text>
          </mat-checkbox>
        </ion-col>
      </ion-row>

      <ng-container *ngIf="parent.samplingBatchForm as samplingForm" >
        <ng-container *ngVar="{
                            samplingRatio: samplingForm|formGetControl:'samplingRatio',
                            samplingRatioText: samplingForm|formGetControl:'samplingRatioText',
                            samplingRatioComputed: samplingForm|formGetControl:'samplingRatioComputed',
                            weightValue: samplingForm|formGetControl: 'weight.value',
                            weightComputed: samplingForm|formGetControl: 'weight.computed',
                            childrenWeightValue: samplingForm|formGetControl: 'childrenWeight.value',
                            childrenWeightComputed: samplingForm|formGetControl: 'childrenWeight.computed',
                            childrenWeightMethodId: samplingForm|formGetControl: 'childrenWeight.methodId'
                         } as controls">
          <ion-row class="ion-no-padding" *ngIf="controls.childrenWeightValue?.value">
            <ion-col offset="4" class="ion-no-padding">
              <mat-form-field class="computed">
                <input matInput
                       autocomplete="off"
                       [formControl]="controls.childrenWeightValue"
                       [readonly]="true"
                       type="number"
                       (click)="parent.selectInputContent($event)"
                       [placeholder]="parent.weightPmfmsByMethod|mapGet:controls.childrenWeightMethodId.value|pmfmName:{i18nPrefix: parent.i18nPmfmPrefix, i18nContext: parent.i18nSuffix}"
                       [tabindex]="-1">

                <!-- copy children weight -->
                <button type="button" mat-icon-button matSuffix
                        (click)="parent.copyChildrenWeight($event, parent.samplingBatchForm)"
                        [title]="'TRIP.BATCH.EDIT.BTN_APPLY_CHILDREN_WEIGHT'|translate">
                  <mat-icon>arrow_downward</mat-icon>
                </button>
                <mat-error *ngIf="controls.childrenWeightValue.errors|mapKeys|arrayFirst; let errorKey" [ngSwitch]="errorKey">
                  <span *ngSwitchCase="'required'" translate>ERROR.FIELD_REQUIRED</span>
                  <span *ngSwitchCase="'min'">{{'ERROR.FIELD_MIN' | translate: controls.childrenWeightValue.errors.min }}</span>
                  <span *ngSwitchCase="'maxDecimals'">
                      {{ 'ERROR.FIELD_MAXIMUM_DECIMALS_COMPACT'| translate:controls.childrenWeightValue.errors.maxDecimals }}</span>
                  <span *ngSwitchDefault translate>ERROR.FIELD_INVALID</span>
                </mat-error>
              </mat-form-field>
            </ion-col>
          </ion-row>

          <ion-row class="ion-no-padding" >

            <!-- Sampling ratio -->
            <ion-col size="4" class="ion-no-padding">
              <mat-sampling-ratio-field [class.computed]="controls.samplingRatioComputed.value"
                                        [readonly]="controls.samplingRatioComputed.value"
                                        [formControl]="controls.samplingRatio"
                                        [format]="parent.samplingRatioFormat"
                                        [tabindex]="parent.tabindex + 32">
              </mat-sampling-ratio-field>
            </ion-col>

            <!-- Sampling weight -->
            <ion-col class="ion-no-padding" *ngIf="parent.defaultWeightPmfm && parent.showSampleWeight">

              <app-pmfm-field [pmfm]="parent.defaultWeightPmfm"
                              [formControl]="controls.weightValue"
                              [readonly]="controls.weightComputed.value"
                              [class.computed]="controls.weightComputed.value"
                              [placeholder]="'TRIP.BATCH.EDIT.SAMPLING_WEIGHT'|translate"
                              [compact]="parent.compact"
                              [tabindex]="parent.tabindex+33"
                              [listenStatusChanges]="true">
              </app-pmfm-field>

            </ion-col>

            <!-- Sampling individual count -->
            <ion-col size="4" class="ion-no-padding" *ngIf="parent.showSampleIndividualCount">
              <mat-form-field>
                <input matInput
                       autocomplete="off"
                       [formControl]="parent.samplingBatchForm|formGetControl: 'individualCount'"
                       type="number"
                       step="1"
                       pattern="[0-9]*"
                       (click)="parent.selectInputContent($event)"
                       [placeholder]="'TRIP.BATCH.EDIT.SAMPLING_INDIVIDUAL_COUNT'|translate"
                       [tabindex]="parent.tabindex + 34">
              </mat-form-field>
            </ion-col>
          </ion-row>
        </ng-container>
      </ng-container>
    </div>

  </ion-grid>

  <!-- DEBUG -->
  <ng-template #debugPanel>
    <app-debug>
      loading: {{parent.loadingSubject|async}}<br/>
      ready: {{parent.readySubject|async}}<br/>
      valid: {{parent.valid}}<br/>
      dirty: {{parent.dirty}}<br/>
      <ng-container *ngIf="parent.samplingBatchForm as childForm">
        <ng-container *ngVar="{
              samplingRatio: childForm|formGetControl:'samplingRatio',
              samplingRatioText: childForm|formGetControl:'samplingRatioText',
              samplingRatioComputed: childForm|formGetControl:'samplingRatioComputed',
              weightValue: childForm|formGetControl: 'weight.value',
              weightComputed: childForm|formGetControl: 'weight.computed',
              childrenWeightValue: childForm|formGetControl: 'childrenWeight.value',
              childrenWeightComputed: childForm|formGetControl: 'childrenWeight.computed',
              childrenWeightMethodId: childForm|formGetControl: 'childrenWeight.methodId'
           } as controls">
          samplingRatio: {{controls.samplingRatio.value|numberFormat: {fixedDecimals: 6} }} <br/>
          samplingRatioText: {{controls.samplingRatioText.value}} (type: {{parent.samplingRatioFormat||'null'}}{{ (controls.samplingRatioComputed.value) ? ', computed' : ''}})<br/>
          sampling.weight: {{controls.weightValue.value }} {{controls.weightComputed.value?'(computed)':'' }}<br/>
          sampling.children weight: {{controls.childrenWeightValue.value }} {{controls.childrenWeightComputed.value?'(computed)':'' }}<br/>
          <br/>
          defaultWeightPmfm: {{parent.defaultWeightPmfm?.label}} (maxDecimals: {{parent.defaultWeightPmfm?.maximumNumberDecimals}})<br/>
          <span *ngIf="parent.weightPmfmsByMethod|mapGet:controls.childrenWeightMethodId?.value; let childrenWeightPmfm">
        Children weight pmfm : {{childrenWeightPmfm.label}} (maxDecimals: {{childrenWeightPmfm.maximumNumberDecimals}})
      </span>
        </ng-container>
      </ng-container>
    </app-debug>
  </ng-template>
</form>
